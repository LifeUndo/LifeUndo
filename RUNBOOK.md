# üö® Runbook: –ß—Ç–æ –¥–µ–ª–∞—Ç—å, –µ—Å–ª–∏ —á—Ç–æ-—Ç–æ –ø–æ—à–ª–æ –Ω–µ —Ç–∞–∫

## üîß –¢–∏–ø–∏—á–Ω—ã–µ –ø—Ä–æ–±–ª–µ–º—ã –∏ —Ä–µ—à–µ–Ω–∏—è

### 405 Not Allowed –Ω–∞ notify
**–°–∏–º–ø—Ç–æ–º—ã:** `POST /api/fk/notify` –≤–æ–∑–≤—Ä–∞—â–∞–µ—Ç 405
**–ü—Ä–∏—á–∏–Ω–∞:** URL —É–∫–∞–∑—ã–≤–∞–µ—Ç –Ω–∞ —Å—Ç–∞—Ç–∏—á–µ—Å–∫–∏–π —Ö–æ—Å—Ç–∏–Ω–≥ –±–µ–∑ —Å–µ—Ä–≤–µ—Ä–Ω–æ–π —á–∞—Å—Ç–∏
**–†–µ—à–µ–Ω–∏–µ:**
1. –ü—Ä–æ–≤–µ—Ä–∏—Ç—å Notify URL –≤ –∫–∞–±–∏–Ω–µ—Ç–µ FK
2. –£–±–µ–¥–∏—Ç—å—Å—è, —á—Ç–æ –∏—Å–ø–æ–ª—å–∑—É–µ—Ç—Å—è Vercel-–¥–æ–º–µ–Ω: `https://<project>.vercel.app/api/fk/notify`
3. –ù–ï –∏—Å–ø–æ–ª—å–∑–æ–≤–∞—Ç—å `https://lifeundo.ru/api/fk/notify` –µ—Å–ª–∏ –¥–æ–º–µ–Ω —Å—Ç–∞—Ç–∏—á–µ—Å–∫–∏–π

### 403 Forbidden –Ω–∞ notify
**–°–∏–º–ø—Ç–æ–º—ã:** `POST /api/fk/notify` –≤–æ–∑–≤—Ä–∞—â–∞–µ—Ç 403
**–ü—Ä–∏—á–∏–Ω–∞:** IP-—Ñ–∏–ª—å—Ç—Ä –∏–ª–∏ –ø—Ä–æ–∫—Å–∏—Ä—É—é—â–∏–µ –∑–∞–≥–æ–ª–æ–≤–∫–∏
**–†–µ—à–µ–Ω–∏–µ:**
1. –í—Ä–µ–º–µ–Ω–Ω–æ –æ—Ç–∫–ª—é—á–∏—Ç—å IP-—Ñ–∏–ª—å—Ç—Ä –≤ –∫–æ–¥–µ (–∑–∞–∫–æ–º–º–µ–Ω—Ç–∏—Ä–æ–≤–∞—Ç—å `isAllowedIp`)
2. –ü—Ä–æ–≤–µ—Ä–∏—Ç—å –∑–∞–≥–æ–ª–æ–≤–æ–∫ `x-forwarded-for` –≤ –ª–æ–≥–∞—Ö
3. –û–±–Ω–æ–≤–∏—Ç—å —Å–ø–∏—Å–æ–∫ —Ä–∞–∑—Ä–µ—à—ë–Ω–Ω—ã—Ö IP –≤ ENV `FK_IPS`
4. –ü—Ä–æ–≤–µ—Ä–∏—Ç—å –Ω–∞—Å—Ç—Ä–æ–π–∫–∏ –ø—Ä–æ–∫—Å–∏/CDN

### Bad signature
**–°–∏–º–ø—Ç–æ–º—ã:** `POST /api/fk/notify` –≤–æ–∑–≤—Ä–∞—â–∞–µ—Ç 400 "Bad signature"
**–ü—Ä–∏—á–∏–Ω–∞:** –ü–æ—Ä—è–¥–æ–∫ –ø–æ–ª–µ–π/—Ñ–æ—Ä–º—É–ª–∞ –ø–æ–¥–ø–∏—Å–∏ –Ω–µ —Å–æ–≤–ø–∞–¥–∞–µ—Ç —Å –∫–∞–±–∏–Ω–µ—Ç–æ–º FK
**–†–µ—à–µ–Ω–∏–µ:**
1. –ü—Ä–æ–≤–µ—Ä–∏—Ç—å —Å—Ö–µ–º—É –ø–æ–¥–ø–∏—Å–∏ –≤ –∫–∞–±–∏–Ω–µ—Ç–µ FK (—Ä–∞–∑–¥–µ–ª "–ü–æ–¥–ø–∏—Å–∏/–ü–∞—Ä–∞–º–µ—Ç—Ä—ã")
2. –°—Ä–∞–≤–Ω–∏—Ç—å —Å —Ñ—É–Ω–∫—Ü–∏—è–º–∏ `buildCreateSignature`/`buildNotifySignature`
3. –û–±–Ω–æ–≤–∏—Ç—å –ø–æ—Ä—è–¥–æ–∫ –ø–æ–ª–µ–π –≤ –∫–æ–¥–µ –ø–æ–¥ —Å—Ö–µ–º—É FK
4. –ü—Ä–æ—Ç–µ—Å—Ç–∏—Ä–æ–≤–∞—Ç—å —ç–º—É–ª—è—Ç–æ—Ä–æ–º notify

### Bad amount
**–°–∏–º–ø—Ç–æ–º—ã:** `POST /api/fk/notify` –≤–æ–∑–≤—Ä–∞—â–∞–µ—Ç 400 "Bad amount"
**–ü—Ä–∏—á–∏–Ω–∞:** –°—É–º–º–∞ –≤ notify –Ω–µ —Å–æ–≤–ø–∞–¥–∞–µ—Ç —Å –æ–∂–∏–¥–∞–µ–º–æ–π
**–†–µ—à–µ–Ω–∏–µ:**
1. –ü—Ä–æ–≤–µ—Ä–∏—Ç—å `priceMap` –≤ –∫–æ–¥–µ
2. –°—Ä–∞–≤–Ω–∏—Ç—å —Å —Å—É–º–º–æ–π –∏–∑ create
3. –ü—Ä–æ–≤–µ—Ä–∏—Ç—å –≤–∞–ª—é—Ç—É –∏ –æ–∫—Ä—É–≥–ª–µ–Ω–∏–µ
4. –£–±–µ–¥–∏—Ç—å—Å—è, —á—Ç–æ –ø–ª–∞–Ω –∫–æ—Ä—Ä–µ–∫—Ç–Ω—ã–π

### FK —Å—Ç—Ä–∞–Ω–∏—Ü–∞ –Ω–µ –æ—Ç–∫—Ä—ã–≤–∞–µ—Ç—Å—è –Ω–∞ iOS
**–°–∏–º–ø—Ç–æ–º—ã:** –ù–∞ iPhone –Ω–µ –ø—Ä–æ–∏—Å—Ö–æ–¥–∏—Ç —Ä–µ–¥–∏—Ä–µ–∫—Ç –Ω–∞ FreeKassa
**–ü—Ä–∏—á–∏–Ω–∞:** –ò—Å–ø–æ–ª—å–∑—É–µ—Ç—Å—è `window.open` –≤–º–µ—Å—Ç–æ `location.href`
**–†–µ—à–µ–Ω–∏–µ:**
1. –ü—Ä–æ–≤–µ—Ä–∏—Ç—å –∫–æ–¥ –≤ `/pricing` - –¥–æ–ª–∂–µ–Ω –±—ã—Ç—å `location.href = data.url`
2. –ù–ï –∏—Å–ø–æ–ª—å–∑–æ–≤–∞—Ç—å `window.open()` –¥–ª—è —Ä–µ–¥–∏—Ä–µ–∫—Ç–∞
3. –ü—Ä–æ–≤–µ—Ä–∏—Ç—å CORS –Ω–∞—Å—Ç—Ä–æ–π–∫–∏

### –î—É–±–ª–∏—Ä—É–µ—Ç—Å—è –≤—ã–¥–∞—á–∞ –ª–∏—Ü–µ–Ω–∑–∏–π
**–°–∏–º–ø—Ç–æ–º—ã:** –ü–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å –ø–æ–ª—É—á–∞–µ—Ç –Ω–µ—Å–∫–æ–ª—å–∫–æ –∫–ª—é—á–µ–π –∑–∞ –æ–¥–∏–Ω –∑–∞–∫–∞–∑
**–ü—Ä–∏—á–∏–Ω–∞:** –ò–¥–µ–º–ø–æ—Ç–µ–Ω—Ç–Ω–æ—Å—Ç—å –Ω–µ —Ä–∞–±–æ—Ç–∞–µ—Ç
**–†–µ—à–µ–Ω–∏–µ:**
1. –ü—Ä–æ–≤–µ—Ä–∏—Ç—å –ª–æ–≥–∏ –Ω–∞ `[FK][notify] Already processed`
2. –£–±–µ–¥–∏—Ç—å—Å—è, —á—Ç–æ `isOrderProcessed` —Ä–∞–±–æ—Ç–∞–µ—Ç –∫–æ—Ä—Ä–µ–∫—Ç–Ω–æ
3. –ü—Ä–æ–≤–µ—Ä–∏—Ç—å KV/DB –Ω–∞ –Ω–∞–ª–∏—á–∏–µ —Ñ–ª–∞–≥–∞ `paid:true`

### Create endpoint –Ω–µ–¥–æ—Å—Ç—É–ø–µ–Ω
**–°–∏–º–ø—Ç–æ–º—ã:** `/pricing` –ø–æ–∫–∞–∑—ã–≤–∞–µ—Ç "–ù–µ —É–¥–∞–ª–æ—Å—å —Å—Ñ–æ—Ä–º–∏—Ä–æ–≤–∞—Ç—å –æ–ø–ª–∞—Ç—É"
**–ü—Ä–∏—á–∏–Ω–∞:** ENV –ø–µ—Ä–µ–º–µ–Ω–Ω—ã–µ –Ω–µ –Ω–∞—Å—Ç—Ä–æ–µ–Ω—ã –∏–ª–∏ API –Ω–µ —Ä–∞–∑–≤—ë—Ä–Ω—É—Ç
**–†–µ—à–µ–Ω–∏–µ:**
1. –ü—Ä–æ–≤–µ—Ä–∏—Ç—å ENV –ø–µ—Ä–µ–º–µ–Ω–Ω—ã–µ –≤ Vercel
2. –£–±–µ–¥–∏—Ç—å—Å—è, —á—Ç–æ `FK_MERCHANT_ID`, `FK_SECRET1` –∑–∞–ø–æ–ª–Ω–µ–Ω—ã
3. –ü—Ä–æ–≤–µ—Ä–∏—Ç—å Redeploy Production
4. –ó–∞–ø—É—Å—Ç–∏—Ç—å smoke test

## üìä –ú–æ–Ω–∏—Ç–æ—Ä–∏–Ω–≥ –∏ –∞–ª–µ—Ä—Ç—ã

### –ù–∞—Å—Ç—Ä–æ–π–∫–∞ –∞–ª–µ—Ä—Ç–æ–≤
1. **–ê–ª–µ—Ä—Ç –ø–æ —É—Å–ø–µ—à–Ω—ã–º –ø–ª–∞—Ç–µ–∂–∞–º:**
   - –°–ª–æ–≤–æ: `[FK][notify] OK`
   - –ß–∞—Å—Ç–æ—Ç–∞: < X –≤ —á–∞—Å
   - –î–µ–π—Å—Ç–≤–∏–µ: –£–≤–µ–¥–æ–º–ª–µ–Ω–∏–µ –≤ Telegram/–ø–æ—á—Ç—É

2. **–ê–ª–µ—Ä—Ç –ø–æ –æ—à–∏–±–∫–∞–º:**
   - –°—Ç–∞—Ç—É—Å: 4xx/5xx –Ω–∞ `/api/fk/notify`
   - –ß–∞—Å—Ç–æ—Ç–∞: > Y –≤ 10 –º–∏–Ω
   - –î–µ–π—Å—Ç–≤–∏–µ: –£–≤–µ–¥–æ–º–ª–µ–Ω–∏–µ –≤ Telegram/–ø–æ—á—Ç—É

### –õ–æ–≥–∏ Vercel
1. –í–∫–ª—é—á–∏—Ç—å —Ñ–∏–ª—å—Ç—Ä –ø–æ –ø—Ä–µ—Ñ–∏–∫—Å—É `FK`
2. –ò—Å–∫–∞—Ç—å: `[FK][create]`, `[FK][notify]`
3. –ú–æ–Ω–∏—Ç–æ—Ä–∏—Ç—å: –≤—Ä–µ–º—è –æ—Ç–≤–µ—Ç–∞, –æ—à–∏–±–∫–∏, –¥—É–±–ª–∏–∫–∞—Ç—ã

## üîê –ë–µ–∑–æ–ø–∞—Å–Ω–æ—Å—Ç—å

### –ß—Ç–æ –ù–ï –ª–æ–≥–∏—Ä–æ–≤–∞—Ç—å
- ‚úÖ `SIGN` (–ø–æ–¥–ø–∏—Å–∏)
- ‚úÖ –°–µ–∫—Ä–µ—Ç—ã (`FK_SECRET1`, `FK_SECRET2`)
- ‚úÖ –ü–æ–ª–Ω—ã–µ email (—Ç–æ–ª—å–∫–æ –º–∞—Å–∫–∏—Ä–æ–≤–∞–Ω–Ω—ã–µ)

### CORS
- ‚úÖ –ö–µ—à –ø—Ä–µ—Ñ–ª–∞–π—Ç–∞ –≤–∫–ª—é—á—ë–Ω (600 —Å–µ–∫)
- ‚úÖ `ALLOWED_ORIGIN=https://lifeundo.ru`
- ‚úÖ –î–ª—è –∞–¥–º–∏–Ω-–ø–∞–Ω–µ–ª–∏ –¥–æ–±–∞–≤–∏—Ç—å –¥–æ–º–µ–Ω –≤ allow-list

### IP-—Ñ–∏–ª—å—Ç—Ä
- ‚ö†Ô∏è –ù–∞ —Å—Ç–∞—Ä—Ç–µ –º–æ–∂–Ω–æ –æ—Å—Ç–∞–≤–∏—Ç—å –≤—ã–∫–ª—é—á–µ–Ω–Ω—ã–º
- ‚ö†Ô∏è –î–µ—Ä–∂–∞—Ç—å –∞–∫—Ç—É–∞–ª—å–Ω—ã–π —Å–ø–∏—Å–æ–∫ IP FK
- ‚ö†Ô∏è –ü—Ä–æ–≤–µ—Ä—è—Ç—å `x-forwarded-for` –∑–∞–≥–æ–ª–æ–≤–∫–∏

## üöÄ –û–ø–µ—Ä–∞—Ü–∏–æ–Ω–Ω—ã–µ –ø—Ä–æ—Ü–µ–¥—É—Ä—ã

### –†–æ—Ç–∞—Ü–∏—è —Å–µ–∫—Ä–µ—Ç–æ–≤
1. –í –∫–∞–±–∏–Ω–µ—Ç–µ FK —Ä–µ–≥–µ–Ω–µ—Ä–∏—Ä–æ–≤–∞—Ç—å `SECRET1`, `SECRET2`, `API_KEY`
2. –û–±–Ω–æ–≤–∏—Ç—å ENV –ø–µ—Ä–µ–º–µ–Ω–Ω—ã–µ –≤ Vercel
3. Redeploy Production
4. –ü—Ä–æ—Ç–µ—Å—Ç–∏—Ä–æ–≤–∞—Ç—å —ç–º—É–ª—è—Ç–æ—Ä–æ–º notify
5. –°–æ—Ö—Ä–∞–Ω–∏—Ç—å —Å–Ω–∞–ø—à–æ—Ç ENV –ª–æ–∫–∞–ª—å–Ω–æ

### –ü–µ—Ä–µ–æ—Ç–ø—Ä–∞–≤–∫–∞ –∫–ª—é—á–µ–π
1. –ò—Å–ø–æ–ª—å–∑–æ–≤–∞—Ç—å –∞–¥–º–∏–Ω-—Å–∫—Ä–∏–ø—Ç: `POST /api/admin/orders`
2. –ê–≤—Ç–æ—Ä–∏–∑–∞—Ü–∏—è: `Authorization: Bearer <ADMIN_TOKEN>`
3. –¢–µ–ª–æ: `{"order_id": "LU-...", "action": "resend_license"}`

### –†–µ—Ñ–∞–Ω–¥—ã/—á–∞—Ä–¥–∂–±–µ–∫–∏
1. –ù–∞–π—Ç–∏ –∑–∞–∫–∞–∑ –ø–æ `intid` –≤ –ª–æ–≥–∞—Ö
2. –ü—Ä–æ–≤–µ—Ä–∏—Ç—å —Å—Ç–∞—Ç—É—Å –≤ –∫–∞–±–∏–Ω–µ—Ç–µ FK
3. –û–±—Ä–∞–±–æ—Ç–∞—Ç—å –≤—Ä—É—á–Ω—É—é —á–µ—Ä–µ–∑ –∞–¥–º–∏–Ω-–ø–∞–Ω–µ–ª—å
4. –û–±–Ω–æ–≤–∏—Ç—å —Å—Ç–∞—Ç—É—Å –≤ KV/DB

## üìû –ö–æ–Ω—Ç–∞–∫—Ç—ã –¥–ª—è —ç—Å–∫–∞–ª–∞—Ü–∏–∏

- **–¢–µ—Ö–Ω–∏—á–µ—Å–∫–∞—è –ø–æ–¥–¥–µ—Ä–∂–∫–∞:** developer@lifeundo.ru
- **FreeKassa –ø–æ–¥–¥–µ—Ä–∂–∫–∞:** —á–µ—Ä–µ–∑ –∫–∞–±–∏–Ω–µ—Ç FK
- **Vercel –ø–æ–¥–¥–µ—Ä–∂–∫–∞:** —á–µ—Ä–µ–∑ dashboard

## üîÑ –†–µ–≥—É–ª—è—Ä–Ω—ã–µ –ø—Ä–æ–≤–µ—Ä–∫–∏

### –ï–∂–µ–¥–Ω–µ–≤–Ω–æ
- [ ] –ü—Ä–æ–≤–µ—Ä–∏—Ç—å –ª–æ–≥–∏ –Ω–∞ –æ—à–∏–±–∫–∏
- [ ] –ú–æ–Ω–∏—Ç–æ—Ä–∏—Ç—å –∫–æ–ª–∏—á–µ—Å—Ç–≤–æ —É—Å–ø–µ—à–Ω—ã—Ö –ø–ª–∞—Ç–µ–∂–µ–π
- [ ] –ü—Ä–æ–≤–µ—Ä–∏—Ç—å –≤—Ä–µ–º—è –æ—Ç–≤–µ—Ç–∞ API

### –ï–∂–µ–Ω–µ–¥–µ–ª—å–Ω–æ
- [ ] –ü—Ä–æ–≤–µ—Ä–∏—Ç—å –∞–∫—Ç—É–∞–ª—å–Ω–æ—Å—Ç—å IP-—Å–ø–∏—Å–∫–∞ FK
- [ ] –û—á–∏—Å—Ç–∏—Ç—å —Å—Ç–∞—Ä—ã–µ –∑–∞–ø–∏—Å–∏ –≤ KV (TTL 30 –¥–Ω–µ–π)
- [ ] –ü—Ä–æ–≤–µ—Ä–∏—Ç—å –±–∞–ª–∞–Ω—Å –≤ –∫–∞–±–∏–Ω–µ—Ç–µ FK

### –ï–∂–µ–º–µ—Å—è—á–Ω–æ
- [ ] –†–æ—Ç–∞—Ü–∏—è —Å–µ–∫—Ä–µ—Ç–æ–≤ FK
- [ ] –û–±–Ω–æ–≤–ª–µ–Ω–∏–µ –∑–∞–≤–∏—Å–∏–º–æ—Å—Ç–µ–π
- [ ] –ü—Ä–æ–≤–µ—Ä–∫–∞ –±–µ–∑–æ–ø–∞—Å–Ω–æ—Å—Ç–∏
