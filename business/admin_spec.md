# Admin Panel Specification

## Обзор

Админ-панель LifeUndo предназначена для управления пользователями, подписками, рассылками и мониторинга ключевых метрик. Доступна только авторизованным администраторам.

## Аутентификация и авторизация

### Роли пользователей
- **admin** - полный доступ ко всем функциям
- **support** - доступ к пользователям и поддержке
- **finance** - доступ к платежам и финансам
- **marketing** - доступ к рассылкам и аналитике

### Безопасность
- Обязательная двухфакторная аутентификация (2FA)
- Сессии с автоматическим истечением (8 часов)
- Аудит всех действий администратора
- IP-ограничения (опционально)

## Структура интерфейса

### 1. Dashboard (Главная)

#### Ключевые метрики (KPI)
- **Активные подписки**: количество пользователей с `status = 'active'`
- **Триалы**: количество пользователей с `status = 'trial'`
- **Платежи за 24ч**: сумма успешных платежей за последние 24 часа
- **Churn Rate**: процент отписок за последний месяц
- **ARPU**: средний доход на пользователя
- **Новые установки**: количество установок расширения за день

#### Графики и тренды
- График подписок (7/30/90 дней)
- График доходов (7/30/90 дней)
- График установок по источникам
- Топ стран по пользователям
- Конверсия триал → подписка

#### Быстрые действия
- Кнопка "Отправить рассылку"
- Кнопка "Создать грант"
- Кнопка "Экспорт данных"

### 2. Users & Subscriptions (Пользователи)

#### Фильтры и поиск
- **Поиск**: email, display_name, account_id
- **Фильтры**:
  - Статус подписки (trial/active/past_due/canceled)
  - План (free/pro/vip/team)
  - Страна
  - Дата регистрации
  - Последняя активность
  - Источник установки

#### Таблица пользователей
Колонки:
- ID пользователя
- Email
- Имя
- Статус подписки
- План
- Дата регистрации
- Последняя активность
- Страна
- Источник
- Действия

#### Действия с пользователем
- **Просмотр профиля**: детальная информация
- **История платежей**: все транзакции
- **Выдать подписку**: создать грант (1 год/VIP/Team)
- **Отменить подписку**: немедленно или в конце периода
- **Принудительная активация**: активировать подписку
- **Отправить рассылку**: ручная отправка шаблона
- **Просмотр логов**: история действий
- **Экспорт данных**: CSV/JSON

#### Детальная страница пользователя
- **Основная информация**: email, имя, регистрация
- **Подписка**: текущий статус, план, даты
- **Платежи**: история транзакций, карты
- **Активность**: логи использования
- **Рассылки**: отправленные письма
- **Риск-профиль**: анти-абуз данные

### 3. Newsletter Manager (Рассылки)

#### Управление шаблонами
- **Список шаблонов**: все доступные шаблоны
- **Предварительный просмотр**: как выглядит письмо
- **Редактирование**: изменение текста и заголовка
- **Активация/деактивация**: включить/выключить шаблон
- **Категории и тона**: фильтрация по типу

#### Ручная отправка
- **Выбор шаблона**: из списка активных
- **Фильтрация получателей**:
  - По статусу подписки
  - По стране
  - По источнику
  - По дате регистрации
- **Предварительный просмотр**: как будет выглядеть письмо
- **Отправка**: немедленно или по расписанию

#### Статистика рассылок
- **Отправлено**: количество отправленных писем
- **Открыто**: процент открытий
- **Клики**: процент кликов по ссылкам
- **Конверсия**: процент подписок после письма
- **Отписки**: количество отписок

#### Получатели шаблонов
- Список пользователей, получивших конкретный шаблон
- Дата отправки
- Статус (отправлено/открыто/кликнуто)
- Возможность повторной отправки

### 4. Grants & Partners (Гранты)

#### Создание грантов
- **Тип гранта**: бесплатная подписка, скидка, партнерский код
- **План**: Pro/VIP/Team
- **Период**: дата начала и окончания
- **Примечание**: причина выдачи гранта
- **Получатель**: конкретный пользователь или группа

#### Партнерские коды
- **Создание кода**: уникальный промо-код
- **Настройки**: скидка, план, лимит использований
- **Статистика**: количество использований
- **Активация/деактивация**: управление доступностью

#### White-label настройки
- **Партнерские бренды**: настройка под партнера
- **Логотипы**: загрузка брендинга
- **Домены**: привязка к доменам партнера
- **Настройки**: кастомизация интерфейса

### 5. Events & Logs (События)

#### События установки
- **Источник**: AMO, сайт, Telegram, рефералы
- **Страна**: географическое распределение
- **Время**: временные паттерны установок
- **Браузер**: статистика по браузерам
- **Версии**: версии расширения

#### Платежные события
- **Webhook логи**: все входящие webhook'и от PSP
- **Неудачные платежи**: причины отказа
- **Споры**: chargeback'и и возвраты
- **Повторные попытки**: логика retry

#### Системные логи
- **Ошибки**: критические ошибки системы
- **Производительность**: время ответа API
- **Безопасность**: подозрительная активность
- **Аудит**: действия администраторов

### 6. Settings (Настройки)

#### PSP Configuration
- **Провайдер**: FreeKassa/Stripe/CloudPayments
- **API ключи**: настройка подключения
- **Webhook URL**: URL для получения уведомлений
- **Тестовый режим**: переключение sandbox/production

#### Email Provider
- **SMTP настройки**: хост, порт, аутентификация
- **DKIM/SPF**: настройка для избежания спама
- **Шаблоны**: системные письма (T-72, T-24, paid, failed)

#### Trial Policy
- **Длительность триала**: по умолчанию 7 дней
- **Ограничения**: один триал на карту/IP/fingerprint
- **Grace period**: период отсрочки после неудачного платежа
- **Retry policy**: количество попыток и интервалы

#### Newsletter Settings
- **Cadence по умолчанию**: интервал между письмами
- **Jitter**: случайная задержка
- **Цикл перезапуска**: через сколько месяцев повторять шаблоны
- **Лимиты**: максимальное количество писем в день

#### Security Settings
- **2FA**: обязательность двухфакторной аутентификации
- **IP Whitelist**: разрешенные IP адреса
- **Session timeout**: время истечения сессии
- **Password policy**: требования к паролям

### 7. Analytics (Аналитика)

#### Финансовая аналитика
- **MRR (Monthly Recurring Revenue)**: месячный повторяющийся доход
- **ARR (Annual Recurring Revenue)**: годовой повторяющийся доход
- **Churn Rate**: процент отписок
- **LTV (Lifetime Value)**: пожизненная ценность клиента
- **CAC (Customer Acquisition Cost)**: стоимость привлечения клиента

#### Пользовательская аналитика
- **DAU/MAU**: ежедневные/месячные активные пользователи
- **Retention**: удержание пользователей
- **Feature Usage**: использование функций
- **Geographic Distribution**: географическое распределение

#### Конверсионная воронка
- **Установка → Регистрация**: конверсия установки в регистрацию
- **Регистрация → Триал**: конверсия в триал
- **Триал → Подписка**: конверсия триала в подписку
- **Подписка → Продление**: конверсия продления

## API Endpoints

### Аутентификация
- `POST /admin/auth/login` - вход в админ-панель
- `POST /admin/auth/logout` - выход
- `POST /admin/auth/2fa` - подтверждение 2FA
- `GET /admin/auth/me` - информация о текущем админе

### Пользователи
- `GET /admin/users` - список пользователей с фильтрами
- `GET /admin/users/:id` - детальная информация о пользователе
- `POST /admin/users/:id/grant` - выдать грант пользователю
- `POST /admin/users/:id/cancel` - отменить подписку
- `GET /admin/users/:id/payments` - история платежей
- `GET /admin/users/:id/newsletters` - история рассылок

### Рассылки
- `GET /admin/newsletters/templates` - список шаблонов
- `POST /admin/newsletters/templates` - создать шаблон
- `PUT /admin/newsletters/templates/:id` - обновить шаблон
- `POST /admin/newsletters/send` - отправить рассылку
- `GET /admin/newsletters/stats` - статистика рассылок

### Аналитика
- `GET /admin/analytics/dashboard` - данные для дашборда
- `GET /admin/analytics/revenue` - финансовая аналитика
- `GET /admin/analytics/users` - пользовательская аналитика
- `GET /admin/analytics/funnel` - конверсионная воронка

### Настройки
- `GET /admin/settings` - получить настройки
- `PUT /admin/settings` - обновить настройки
- `POST /admin/settings/test-email` - тест отправки email
- `POST /admin/settings/test-psp` - тест подключения к PSP

## Технические требования

### Frontend
- **Framework**: Next.js с TypeScript
- **UI Library**: Tailwind CSS + Headless UI
- **Charts**: Recharts или Chart.js
- **Tables**: TanStack Table для сложных таблиц
- **Forms**: React Hook Form + Zod для валидации

### Backend
- **API**: Next.js API Routes
- **Database**: PostgreSQL с Prisma ORM
- **Caching**: Redis для кэширования
- **Queue**: BullMQ для фоновых задач
- **Monitoring**: Winston для логирования

### Безопасность
- **Rate Limiting**: ограничение запросов
- **CORS**: настройка для админ-панели
- **CSRF Protection**: защита от CSRF атак
- **Input Validation**: валидация всех входных данных
- **SQL Injection**: использование параметризованных запросов

## Развертывание

### Environment Variables
```env
# Database
DATABASE_URL=postgresql://user:password@localhost:5432/lifeundo

# Redis
REDIS_URL=redis://localhost:6379

# Email
SMTP_HOST=smtp.gmail.com
SMTP_PORT=587
SMTP_USER=admin@lifeundo.ru
SMTP_PASS=password

# PSP
PSP_PROVIDER=stripe
STRIPE_SECRET_KEY=sk_test_...
STRIPE_WEBHOOK_SECRET=whsec_...

# Admin
ADMIN_JWT_SECRET=your-secret-key
ADMIN_SESSION_TIMEOUT=28800
```

### Docker Compose
```yaml
version: '3.8'
services:
  app:
    build: .
    ports:
      - "3000:3000"
    environment:
      - DATABASE_URL=postgresql://postgres:password@db:5432/lifeundo
      - REDIS_URL=redis://redis:6379
    depends_on:
      - db
      - redis

  db:
    image: postgres:15
    environment:
      - POSTGRES_DB=lifeundo
      - POSTGRES_USER=postgres
      - POSTGRES_PASSWORD=password
    volumes:
      - postgres_data:/var/lib/postgresql/data

  redis:
    image: redis:7-alpine
    volumes:
      - redis_data:/data

volumes:
  postgres_data:
  redis_data:
```

## Мониторинг и алерты

### Критические алерты
- **High Error Rate**: > 5% ошибок API
- **Database Connection**: потеря соединения с БД
- **Payment Failures**: > 10% неудачных платежей
- **Newsletter Queue**: очередь рассылок > 1000

### Операционные метрики
- **Response Time**: время ответа API < 500ms
- **Uptime**: доступность > 99.9%
- **Queue Processing**: обработка очереди < 5 минут
- **Admin Activity**: активность администраторов

### Логирование
- **Structured Logs**: JSON формат для всех логов
- **Log Levels**: ERROR, WARN, INFO, DEBUG
- **Log Rotation**: ротация логов по размеру и времени
- **Centralized Logging**: отправка в централизованную систему

## Планы развития

### Краткосрочные (1-3 месяца)
- Базовый функционал админ-панели
- Интеграция с PSP
- Система рассылок
- Базовые метрики

### Среднесрочные (3-6 месяцев)
- Расширенная аналитика
- A/B тестирование
- Автоматизация процессов
- Интеграция с внешними сервисами

### Долгосрочные (6+ месяцев)
- Machine Learning для прогнозирования
- Автоматическое управление рассылками
- Интеграция с CRM системами
- Мобильное приложение для админов
