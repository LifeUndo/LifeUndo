# Newsletter System Specification

## Обзор системы

Система рассылок LifeUndo предназначена для удержания пользователей, которые не продлили подписку после окончания триала. Использует эмоциональные кейсы ("страшилки") для мотивации к возврату.

## Основные принципы

### 1. Anti-Duplicate Logic
- Каждый пользователь получает уникальные шаблоны
- Отслеживание через таблицу `newsletter_sent`
- Цикл повторяется только через 12 месяцев

### 2. Персонализация
- Placeholders: `{user_name}`, `{plan}`, `{example}`
- Адаптация под тип пользователя (студент, бизнес, креатив)

### 3. Остановка рассылок
- Автоматическая остановка при активации подписки
- Ручная остановка через админ-панель
- Opt-out ссылки в письмах

## Алгоритм выбора шаблона

```sql
-- Псевдокод выбора шаблона
SELECT template_id FROM newsletter_templates 
WHERE locale = 'ru' AND is_active = true
ORDER BY random()
LIMIT 1
-- Проверить, что template_id НЕ в newsletter_sent для данного пользователя
```

## Расписание рассылок

### По умолчанию
- **Cadence**: 30 дней между письмами
- **Jitter**: случайная задержка 0-72 часа
- **Время**: избегать выходных и праздников

### Настройки по типам пользователей
- **Студенты**: 21 день (более частые напоминания)
- **Бизнес**: 35 дней (менее навязчиво)
- **Креатив**: 30 дней (стандартно)

## Правила остановки рассылок

### Автоматическая остановка
1. **Активация подписки**: `subscription.status = 'active'`
2. **Ручная отмена**: пользователь нажал "Отписаться"
3. **Неактивный email**: 3 подряд неудачные доставки

### Ручная остановка (админ)
- Временная остановка для пользователя
- Полная остановка рассылки
- Архивация шаблона

## Структура шаблонов

### Категории
- `education` - студенты, преподаватели
- `business` - корпоративные пользователи
- `creative` - дизайнеры, музыканты, писатели
- `legal` - юристы, нотариусы
- `tech` - разработчики, IT
- `finance` - бухгалтеры, финансисты
- `research` - ученые, исследователи
- `media` - журналисты, блогеры
- `healthcare` - врачи, медперсонал
- `personal` - личные проекты

### Тоны
- `scary` - эмоциональные кейсы потерь
- `educational` - обучающие примеры
- `neutral` - информационные сообщения

## Логика цикла рассылок

### Первый цикл (0-12 месяцев)
1. Отправка всех доступных шаблонов
2. Случайный порядок для каждого пользователя
3. Отслеживание через `newsletter_sent`

### Перезапуск цикла (через 12 месяцев)
1. Сброс `newsletter_sent` для пользователя
2. Установка `cycle_started_at = now()`
3. Начало нового цикла

### Исчерпание шаблонов
- Если все шаблоны отправлены: пауза на 365 дней
- Уведомление админа о необходимости новых шаблонов

## Метрики и аналитика

### Отслеживаемые события
- `email_sent` - письмо отправлено
- `email_opened` - письмо открыто
- `email_clicked` - клик по ссылке
- `subscription_renewed` - продление после письма

### KPI
- **Open Rate**: > 25%
- **Click Rate**: > 5%
- **Conversion Rate**: > 2% (письмо → подписка)
- **Unsubscribe Rate**: < 1%

## Технические требования

### Worker Requirements
- **Frequency**: каждые 10 минут
- **Batch Size**: до 50 пользователей за раз
- **Lock Mechanism**: `SELECT FOR UPDATE`
- **Retry Logic**: 3 попытки с экспоненциальной задержкой

### Email Provider
- **SMTP/SES**: надежная доставка
- **DKIM/SPF**: настройка для избежания спама
- **Unsubscribe Headers**: обязательные заголовки

### Database Performance
- **Indexes**: на `next_send_at`, `account_id`, `template_id`
- **Partitioning**: по дате для `newsletter_sent`
- **Cleanup**: архивация старых записей (> 2 лет)

## Безопасность и соответствие

### GDPR/Privacy
- **Consent**: явное согласие на рассылки
- **Data Retention**: удаление через 2 года
- **Right to be Forgotten**: полное удаление по запросу

### Anti-Spam
- **CAN-SPAM**: соответствие американскому закону
- **Unsubscribe**: простая отписка в 1 клик
- **Sender Reputation**: мониторинг репутации домена

## Мониторинг и алерты

### Критические алерты
- **High Bounce Rate**: > 10%
- **Spam Complaints**: > 0.1%
- **Worker Down**: отсутствие активности > 1 час

### Операционные метрики
- **Queue Size**: количество ожидающих отправки
- **Processing Time**: время обработки батча
- **Error Rate**: процент ошибок отправки

## Планы развития

### Краткосрочные (1-3 месяца)
- A/B тестирование шаблонов
- Сегментация по поведению
- Интеграция с аналитикой

### Среднесрочные (3-6 месяцев)
- ML-модель для выбора шаблонов
- Динамическая персонализация
- Интеграция с CRM

### Долгосрочные (6+ месяцев)
- Predictive analytics
- Автоматическая генерация контента
- Мультиканальные рассылки (email + push + SMS)
