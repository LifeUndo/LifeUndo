# üìÖ –ü–ª–∞–Ω "–î–µ–Ω—å-0/–î–µ–Ω—å-1": –ü–µ—Ä–≤—ã–µ —Ç—Ä–∞–Ω–∑–∞–∫—Ü–∏–∏

## üåÖ –î–µ–Ω—å-0: –ü–µ—Ä–µ–¥ –ø–µ—Ä–≤—ã–º –ø–ª–∞—Ç—ë–∂–æ–º

### üîß –¢–µ—Ö–Ω–∏—á–µ—Å–∫–∞—è –ø–æ–¥–≥–æ—Ç–æ–≤–∫–∞
- [ ] **DNS/–¥–æ–º–µ–Ω—ã:** –ü—Ä–æ–≤–µ—Ä–∏—Ç—å, —á—Ç–æ `lifeundo.ru` –Ω–µ –Ω–∞ Vercel
- [ ] **Notify URL:** –£–±–µ–¥–∏—Ç—å—Å—è, —á—Ç–æ —Å—Ç–æ–∏—Ç `https://<project>.vercel.app/api/fk/notify` (–ù–ï `lifeundo.ru`)
- [ ] **ENV —Å–Ω–∞–ø—à–æ—Ç:** –õ–æ–∫–∞–ª—å–Ω–æ –∑–∞—Ñ–∏–∫—Å–∏—Ä–æ–≤–∞—Ç—å:
  ```
  FK_MERCHANT_ID=<—Ç–µ–∫—É—â–∏–π>
  FK_SECRET1=<—Ç–µ–∫—É—â–∏–π>
  FK_SECRET2=<—Ç–µ–∫—É—â–∏–π>
  ADMIN_TOKEN=<—Ç–µ–∫—É—â–∏–π>
  ALLOWED_ORIGIN=https://lifeundo.ru
  CURRENCY=RUB
  ```

### üß™ –¢–µ—Å—Ç–∏—Ä–æ–≤–∞–Ω–∏–µ
- [ ] **Smoke Test:**
  ```bash
  .\smoke-test-freekassa.ps1 https://<project>.vercel.app
  ```
- [ ] **–≠–º—É–ª—è—Ç–æ—Ä Notify:**
  ```bash
  .\fk-notify-sim.ps1 https://<project>.vercel.app MERCHANT_ID 2490.00 LU-test-123 SECRET2
  ```
- [ ] **–ù–µ–≥–∞—Ç–∏–≤–Ω—ã–µ —Ç–µ—Å—Ç—ã:**
  ```bash
  ./negative-tests.sh https://<project>.vercel.app MERCHANT_ID SECRET2
  ```

### üìä –ú–æ–Ω–∏—Ç–æ—Ä–∏–Ω–≥
- [ ] **KV TTL:** –ü—Ä–æ–≤–µ—Ä–∏—Ç—å, —á—Ç–æ –∫–ª—é—á `order:<id>` —Å–æ–∑–¥–∞—ë—Ç—Å—è —Å TTL 30 –¥–Ω–µ–π
- [ ] **–õ–æ–≥–∏ —Ñ–∏–ª—å—Ç—Ä–æ–º:** –ù–∞—Å—Ç—Ä–æ–∏—Ç—å —Ñ–∏–ª—å—Ç—Ä –ø–æ –ø—Ä–µ—Ñ–∏–∫—Å—É `FK` –≤ Vercel Logs
- [ ] **–ê–ª–µ—Ä—Ç—ã:** –ù–∞—Å—Ç—Ä–æ–∏—Ç—å —É–≤–µ–¥–æ–º–ª–µ–Ω–∏—è –Ω–∞ `[FK][notify] OK` –∏ –æ—à–∏–±–∫–∏

---

## üöÄ –î–µ–Ω—å-1: –ü–µ—Ä–≤—ã–µ —Ä–µ–∞–ª—å–Ω—ã–µ –ø–ª–∞—Ç–µ–∂–∏

### üì± –¢–µ—Å—Ç –Ω–∞ iPhone
- [ ] –û—Ç–∫—Ä—ã—Ç—å `/pricing` –Ω–∞ iPhone
- [ ] –í–≤–µ—Å—Ç–∏ email ‚Üí "–ö—É–ø–∏—Ç—å VIP"
- [ ] –†–µ–¥–∏—Ä–µ–∫—Ç –Ω–∞ FreeKassa
- [ ] –ü—Ä–æ–≤–µ—Å—Ç–∏ —Ç–µ—Å—Ç–æ–≤—É—é –æ–ø–ª–∞—Ç—É
- [ ] –†–µ–¥–∏—Ä–µ–∫—Ç –Ω–∞ `/success.html`

### üìä –ü—Ä–æ–≤–µ—Ä–∫–∞ –ª–æ–≥–æ–≤
- [ ] **–û–¥–Ω–∞ —Å—Ç—Ä–æ–∫–∞** `[FK][notify] OK` —Å —Ç–µ–º –∂–µ `order_id`
- [ ] **–ë–µ–∑ –¥—É–±–ª–µ–π** - —Ç–æ–ª—å–∫–æ –æ–¥–∏–Ω —É—Å–ø–µ—à–Ω—ã–π notify
- [ ] **–ë–µ–∑ —Å–µ–∫—Ä–µ—Ç–æ–≤** –≤ –ª–æ–≥–∞—Ö (—Ç–æ–ª—å–∫–æ –º–∞—Å–∫–∏—Ä–æ–≤–∞–Ω–Ω—ã–µ –¥–∞–Ω–Ω—ã–µ)

### üóÑÔ∏è –ü—Ä–æ–≤–µ—Ä–∫–∞ KV/DB
- [ ] **KV –∑–∞–ø–∏—Å—å:** `paid:true`, `intid`, `amount`, `paid_at`
- [ ] **TTL —É—Å—Ç–∞–Ω–æ–≤–ª–µ–Ω:** 30 –¥–Ω–µ–π –¥–ª—è –∞–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–æ–π –æ—á–∏—Å—Ç–∫–∏

### üîß –ü—Ä–æ–≤–µ—Ä–∫–∞ –∞–¥–º–∏–Ω-–ø–∞–Ω–µ–ª–∏
- [ ] **–ü–æ–∏—Å–∫ –∑–∞–∫–∞–∑–∞:**
  ```bash
  GET /api/admin/orders?order_id=LU-<—Ä–µ–∞–ª—å–Ω—ã–π-id>
  Authorization: Bearer <ADMIN_TOKEN>
  ```
- [ ] **–°—Ç–∞—Ç—É—Å:** "Paid" —Å –∫–æ—Ä—Ä–µ–∫—Ç–Ω—ã–º–∏ –¥–∞–Ω–Ω—ã–º–∏
- [ ] **–¢–µ—Å—Ç –ø–µ—Ä–µ–æ—Ç–ø—Ä–∞–≤–∫–∏:**
  ```bash
  POST /api/admin/orders
  {"order_id": "LU-<—Ä–µ–∞–ª—å–Ω—ã–π-id>", "action": "resend_license"}
  ```

### üíª –¢–µ—Å—Ç –Ω–∞ –¥–µ—Å–∫—Ç–æ–ø–µ
- [ ] –ü–æ–≤—Ç–æ—Ä–∏—Ç—å —Ç–µ—Å—Ç –Ω–∞ –¥–µ—Å–∫—Ç–æ–ø–µ
- [ ] –ü—Ä–æ–≤–µ—Ä–∏—Ç—å, —á—Ç–æ –≤—Å–µ —Ä–∞–±–æ—Ç–∞–µ—Ç –æ–¥–∏–Ω–∞–∫–æ–≤–æ

---

## üö® –ë—ã—Å—Ç—Ä—ã–π Rollback-–ø–ª–∞–Ω

### Bad signature/Bad amount
**–°–∏–º–ø—Ç–æ–º—ã:** `400 Bad signature` –∏–ª–∏ `400 Bad amount`
**–†–µ—à–µ–Ω–∏–µ:**
1. –°–≤–µ—Ä–∏—Ç—å —Å—Ö–µ–º—É –ø–æ–¥–ø–∏—Å–∏ –≤ –∫–∞–±–∏–Ω–µ—Ç–µ FK
2. –ü–æ–ø—Ä–∞–≤–∏—Ç—å `buildCreateSignature`/`buildNotifySignature`
3. –û–±–Ω–æ–≤–∏—Ç—å –≤–∞–ª–∏–¥–∞—Ü–∏—é —Å—É–º–º—ã –≤ `priceMap`
4. Redeploy Production
5. –ü—Ä–æ—Ç–µ—Å—Ç–∏—Ä–æ–≤–∞—Ç—å —ç–º—É–ª—è—Ç–æ—Ä–æ–º notify

### 405/404 –Ω–∞ notify
**–°–∏–º–ø—Ç–æ–º—ã:** `405 Not Allowed` –∏–ª–∏ `404 Not Found`
**–†–µ—à–µ–Ω–∏–µ:**
1. –ü–µ—Ä–µ–∫–ª—é—á–∏—Ç—å Notify URL –Ω–∞ Vercel-–¥–æ–º–µ–Ω
2. –ü–æ–≤—Ç–æ—Ä–Ω–æ "–ü—Ä–æ–≤–µ—Ä–∏—Ç—å —Å—Ç–∞—Ç—É—Å" –≤ –∫–∞–±–∏–Ω–µ—Ç–µ FK
3. –£–±–µ–¥–∏—Ç—å—Å—è, —á—Ç–æ –≤–æ–∑–≤—Ä–∞—â–∞–µ—Ç 200

### –î—É–±–ª–∏—Ä–æ–≤–∞–Ω–∏–µ –≤—ã–¥–∞—á–∏
**–°–∏–º–ø—Ç–æ–º—ã:** –ü–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å –ø–æ–ª—É—á–∞–µ—Ç –Ω–µ—Å–∫–æ–ª—å–∫–æ –∫–ª—é—á–µ–π
**–†–µ—à–µ–Ω–∏–µ:**
1. –ü—Ä–æ–≤–µ—Ä–∏—Ç—å KV-—Ñ–ª–∞–≥ `paid:true`
2. –ü—Ä–∏ –Ω–µ–æ–±—Ö–æ–¥–∏–º–æ—Å—Ç–∏ –≤—Ä—É—á–Ω—É—é –ø—Ä–æ—Å—Ç–∞–≤–∏—Ç—å —Ñ–ª–∞–≥
3. –ü–æ–≤—Ç–æ—Ä–Ω–æ –æ—Ç–ø—Ä–∞–≤–∏—Ç—å –∫–ª—é—á —á–µ—Ä–µ–∑ –∞–¥–º–∏–Ω-—Å–∫—Ä–∏–ø—Ç
4. –ü—Ä–æ–≤–µ—Ä–∏—Ç—å –∏–¥–µ–º–ø–æ—Ç–µ–Ω—Ç–Ω–æ—Å—Ç—å –≤ –ª–æ–≥–∞—Ö

### –£–ø–∞–ª –ø–æ—á—Ç–æ–≤—ã–π –ø—É—Ç—å
**–°–∏–º–ø—Ç–æ–º—ã:** –ö–ª—é—á–∏ –Ω–µ –æ—Ç–ø—Ä–∞–≤–ª—è—é—Ç—Å—è –Ω–∞ email
**–†–µ—à–µ–Ω–∏–µ:**
1. **–í–∞—Ä–∏–∞–Ω—Ç A:** –í–µ—Ä–Ω—É—Ç—å `5xx` –Ω–∞ notify (FK –ø–µ—Ä–µ—à–ª—ë—Ç –ø–æ–≤—Ç–æ—Ä)
2. **–í–∞—Ä–∏–∞–Ω—Ç B:** –ü—Ä–∏–Ω—è—Ç—å `OK`, –Ω–æ –ø–æ—Å—Ç–∞–≤–∏—Ç—å –∑–∞–¥–∞—á—É "resend" –≤ –æ—á–µ—Ä–µ–¥—å
3. –ù–µ —Ç–µ—Ä—è—Ç—å `intid` –¥–ª—è –æ—Ç—Å–ª–µ–∂–∏–≤–∞–Ω–∏—è

---

## ‚úÖ –ú–∏–Ω–∏-–∫–æ–Ω—Ç—Ä–æ–ª—å–Ω–∞—è –¥–ª—è —Å–≤–æ–¥–Ω–æ–≥–æ –æ—Ç—á—ë—Ç–∞

### –ü–æ—Å–ª–µ 1-2 –ø–ª–∞—Ç–µ–∂–µ–π –ø—Ä–æ–≤–µ—Ä–∏—Ç—å:

- [ ] **–°–∫—Ä–∏–Ω "–ü—Ä–æ–≤–µ—Ä–∏—Ç—å —Å—Ç–∞—Ç—É—Å" = 200** (–≤ –∫–∞–±–∏–Ω–µ—Ç–µ FK)
- [ ] **–õ–æ–≥–∏ Vercel:**
  - `create 200` - —É—Å–ø–µ—à–Ω–æ–µ —Å–æ–∑–¥–∞–Ω–∏–µ —Å—Å—ã–ª–∫–∏
  - `notify 200` - —É—Å–ø–µ—à–Ω—ã–π notify
  - `[FK][notify] OK` - –±–µ–∑ —Å–µ–∫—Ä–µ—Ç–æ–≤ –≤ –ª–æ–≥–∞—Ö
- [ ] **KV –∑–∞–ø–∏—Å–∏:**
  - –°–æ–∑–¥–∞–Ω—ã –∫–æ—Ä—Ä–µ–∫—Ç–Ω–æ
  - –û—á–∏—â–∞—é—Ç—Å—è –ø–æ TTL (30 –¥–Ω–µ–π)
- [ ] **–ê–¥–º–∏–Ω-—Å–∫—Ä–∏–ø—Ç:**
  - –ü–æ–∏—Å–∫ –ø–æ `order_id` —Ä–∞–±–æ—Ç–∞–µ—Ç
  - –ü–æ–∏—Å–∫ –ø–æ `email` —Ä–∞–±–æ—Ç–∞–µ—Ç
  - `resend_license` —Ä–∞–±–æ—Ç–∞–µ—Ç
- [ ] **–ù–µ–≥–∞—Ç–∏–≤–Ω—ã–µ —Ç–µ—Å—Ç—ã:**
  - "Bad signature" - –æ–∂–∏–¥–∞–µ–º–æ–µ –ø–æ–≤–µ–¥–µ–Ω–∏–µ
  - "Bad amount" - –æ–∂–∏–¥–∞–µ–º–æ–µ –ø–æ–≤–µ–¥–µ–Ω–∏–µ
  - "Duplicate notify" - –æ–∂–∏–¥–∞–µ–º–æ–µ –ø–æ–≤–µ–¥–µ–Ω–∏–µ

---

## üìä –ö—Ä–∏—Ç–µ—Ä–∏–∏ —É—Å–ø–µ—Ö–∞

### –î–µ–Ω—å-0 (–≥–æ—Ç–æ–≤–Ω–æ—Å—Ç—å)
- [ ] –í—Å–µ —Ç–µ—Å—Ç—ã –ø—Ä–æ—Ö–æ–¥—è—Ç
- [ ] –ú–æ–Ω–∏—Ç–æ—Ä–∏–Ω–≥ –Ω–∞—Å—Ç—Ä–æ–µ–Ω
- [ ] Rollback-–ø–ª–∞–Ω –≥–æ—Ç–æ–≤

### –î–µ–Ω—å-1 (–ø–µ—Ä–≤—ã–µ –ø–ª–∞—Ç–µ–∂–∏)
- [ ] iPhone –ø–ª–∞—Ç–µ–∂ —É—Å–ø–µ—à–µ–Ω
- [ ] Desktop –ø–ª–∞—Ç–µ–∂ —É—Å–ø–µ—à–µ–Ω
- [ ] –õ–æ–≥–∏ –∫–æ—Ä—Ä–µ–∫—Ç–Ω—ã
- [ ] –ê–¥–º–∏–Ω-–ø–∞–Ω–µ–ª—å —Ä–∞–±–æ—Ç–∞–µ—Ç
- [ ] KV –∑–∞–ø–∏—Å–∏ —Å–æ–∑–¥–∞–Ω—ã

### –î–µ–Ω—å-2+ (—Å—Ç–∞–±–∏–ª—å–Ω–æ—Å—Ç—å)
- [ ] –ù–µ—Ç –æ—à–∏–±–æ–∫ –≤ –ª–æ–≥–∞—Ö
- [ ] –í—Ä–µ–º—è –æ—Ç–≤–µ—Ç–∞ < 500ms
- [ ] –í—Å–µ —É–≤–µ–¥–æ–º–ª–µ–Ω–∏—è –ø—Ä–∏—Ö–æ–¥—è—Ç
- [ ] –ü–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª–∏ –ø–æ–ª—É—á–∞—é—Ç –∫–ª—é—á–∏

---

## üéØ –ì–æ—Ç–æ–≤–Ω–æ—Å—Ç—å –∫ –ø—Ä–æ–¥–∞–∫—à–µ–Ω—É

**‚úÖ –í—Å–µ —Å–∏—Å—Ç–µ–º—ã –≥–æ—Ç–æ–≤—ã:**
- –ë–æ–µ–≤–∞—è –Ω–∞–¥—ë–∂–Ω–æ—Å—Ç—å –≤–∫–ª—é—á–µ–Ω–∞
- –ú–æ–Ω–∏—Ç–æ—Ä–∏–Ω–≥ –Ω–∞—Å—Ç—Ä–æ–µ–Ω
- Rollback-–ø–ª–∞–Ω –≥–æ—Ç–æ–≤
- –ê–¥–º–∏–Ω-–ø–∞–Ω–µ–ª—å —Ä–∞–±–æ—Ç–∞–µ—Ç
- –¢–µ—Å—Ç—ã –ø–æ–∫—Ä—ã–≤–∞—é—Ç –≤—Å–µ —Å—Ü–µ–Ω–∞—Ä–∏–∏

**üöÄ –°–ª–µ–¥—É—é—â–∏–π —à–∞–≥:** –í—ã–ø–æ–ª–Ω–∏—Ç—å –ø–ª–∞–Ω "–î–µ–Ω—å-0" –∏ –ø—Ä–æ–≤–µ—Å—Ç–∏ –ø–µ—Ä–≤—ã–µ —Ä–µ–∞–ª—å–Ω—ã–µ –ø–ª–∞—Ç–µ–∂–∏!
