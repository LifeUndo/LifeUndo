LifeUndo — handoff summary for new chat
Date: 2025-09-17 23:50:50

=== 0) Коротко (что важно помнить) ===
• Текущая стабильная сборка: 0.3.7 (Firefox). Кнопка “Активировать VIP” в попапе открывает options.html (через browser.runtime.openOptionsPage). Импорт VIP .lifelic проходит на странице “Лицензия”, VIP активируется, попап показывает VIP.
• Языки: RU/EN. Должны локализоваться: заголовок “Что нового”, подписи в футере (Сайт/Приватность/Поддержка), тексты в options.
• Валидация лицензии офлайн: ECDSA P-256 / SHA-256. Поддержка RAW и DER сигнатур. Не хранить приватные ключи в репозитории!
• Упаковка XPI: в корне архива manifest.json, POSIX-пути “/” внутри. Лучший способ — `npx web-ext build`.
• При публикации в AMO всегда поднимать версию. ID аддона в manifest.json должен совпадать с ID в Developer Hub.

=== 1) Архитектура расширения (минимум) ===
• popup.html / popup.js — лёгкий UI. Кнопка “Активировать VIP” не импортирует файл сама, а ОТКРЫВАЕТ options.html.
• options.html / options.js — единая точка импорта/проверки/удаления лицензии:
  – Выбрать .lifelic → Импортировать → Проверить → (опционально) Удалить ключ
  – Пошаговая подсветка: активная кнопка синяя; “Удалить ключ” — красная.
• _locales/en/messages.json и _locales/ru/messages.json — тексты, включая футер, “Что нового” и статусы.
• manifest.json — версия, иконки (16/32/48/96/128), browser_specific_settings.gecko.id.

=== 2) VIP лицензия (.lifelic) ===
• Формат: JSON (может быть также “armored” с BEGIN/END — разбор поддержан).
• Поля: license { plan: "vip", devices, expiry (YYYY-MM-DD), issued_to, iat, nonce }, signature { publicKeyJwk, sig_b64, alg }.
• Проверка: каноническая сериализация, тест нескольких вариантов (minified/pretty/canonical, с \n и \r\n), попытка и DER, и RAW сигнатур.
• Хранение статуса: browser.storage.local → lu_plan: "vip", lu_license: <object>.
• Безопасность: только публичный ключ в коде; приватный ключ — ТОЛЬКО локально у владельца.

=== 3) UX/локализация (договорённости) ===
• Попап:
  – Заголовок “Что нового” локализовать: RU → “Что нового”, EN → “What’s new”.
  – Внизу: Сайт · Приватность · Поддержка — локализовать и открывать в новой вкладке.
  – Не показывать ссылку “Лицензия” в футере (функция перенесена в кнопку в попапе).
  – Размер попапа — фиксированный (около 340px), без «прыжков».
• Options (“Лицензия”):
  – Горизонтальная раскладка блока импорта.
  – Пошаговая подсветка: “Выбрать .lifelic” (синяя) → после выбора “Импортировать” (синяя) → после успеха “Проверить” (синяя).
  – Кнопка “Удалить ключ” — красная и с явным текстом; RU/EN локализация.
• При активной лицензии:
  – Попап: бейдж VIP, скрыты/выключены PRO-CTA, надпись “VIP активен”.

=== 4) Сборка и публикация ===
A) Быстрая локальная проверка (Firefox):
  1) about:debugging → This Firefox → Load Temporary Add-on → выбрать manifest.json.
  2) Попап → Активировать VIP → откроется options.html → импортировать .lifelic → получить зелёный статус.
  3) Вернуться в попап → статус VIP активен.

B) Упаковка XPI (Windows без терминала):
  1) Открыть папку firefox-версии (где лежит manifest.json, _locales, icons, popup.*, options.*).
  2) Выделить ВСЁ содержимое папки (не саму папку!) → ПКМ → Отправить → Сжатая ZIP-папка.
  3) Переименовать архив в LifeUndo-0.3.7-firefox.xpi.
  4) Проверить, что в корне архива лежит manifest.json, и пути внутри через “/”.

C) Упаковка XPI (через web-ext):
  npx web-ext build --source-dir=firefox --artifacts-dir=./dist --overwrite-dest

D) Публикация в AMO:
  – Upload New Version → приложить XPI.
  – Release notes (RU/EN) — короткие заготовки ниже.
  – Проверить отсутствие новых permissions. Дождаться валидации.

=== 5) Release notes 0.3.7 (готовые короткие тексты) ===
EN:
LifeUndo 0.3.7 — “Activate VIP” opens built-in License page (offline ECDSA). RU/EN toggle fixed (incl. What’s new & footer). UI polish: stable popup size, correct VIP/PRO states.

RU:
LifeUndo 0.3.7 — «Активировать VIP» открывает встроенную страницу «Лицензия» (офлайн ECDSA). Исправлено переключение RU/EN (включая «Что нового» и футер). Полировка UI: стабильный размер попапа, корректные статусы VIP/PRO.

=== 6) Частые проблемы и быстрые проверки ===
• Кнопка Activate VIP “молчит” → проверьте, что обработчик в popup.js вызывает browser.runtime.openOptionsPage().
• Импорт в options “молчит” → проверить консоль страницы options.html; убедиться, что выбран файл JSON/.lifelic; статусная строка включена.
• После импорта попап не меняется → слушатель browser.storage.onChanged должен обновлять UI без перезапуска.
• AMO ругается “Invalid file name … _locales\…” → пересобрать XPI с POSIX-путями (web-ext) или Windows ZIP «из содержимого».
• AMO ругается на иконки → убедиться, что все размеры из manifest.json реально присутствуют.
• ID аддона → browser_specific_settings.gecko.id должен соответствовать ID в Developer Hub.

=== 7) Ближайшие задачи (для Cursor/разработчика) ===
Task A — Footer i18n finish:
• Убедиться, что подписи “Website/Privacy/Support” берутся из i18n и переключаются по RU/EN.
• Открывать ссылки в новой вкладке. Ссылку “Лицензия” в футере не показывать.

Task B — Options UX polish:
• Сохранить последовательную подсветку кнопок (Choose → Import → Verify).
• По завершении успешного импорта отправить событие (runtime.sendMessage 'license-updated'), попап ловит и моментально обновляет UI.

Task C — “What’s new” RU:
• Гарантировать локализацию заголовка и текста модала “Что нового” на RU.

Task D — Website sync:
• На сайте обновить новости/Changelog для 0.3.7 (RU/EN).
• Pricing/links: оставить «Оплата → сайт», пока не включена платёжная система.

=== 8) Нельзя делать ===
• Не добавлять в репозиторий файлы с паролями/приватными ключами и .lifelic.
• Не коммитить lifeundo_private_key.jwk.
• Не менять ID аддона без крайней необходимости.

=== 9) Контрольный список перед следующей публикацией ===
[ ] Версия повышена в manifest.json.
[ ] “Activate VIP” открывает options.html (openOptionsPage).
[ ] Импорт .lifelic зелёный, Verify проходит.
[ ] Попап показывает VIP, PRO-элементы скрыты.
[ ] RU/EN корректно меняет “Что нового” и футер.
[ ] XPI: manifest.json в корне, POSIX-пути.
[ ] Release notes вставлены (RU/EN).

— Конец —
